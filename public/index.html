<!doctype html>
<html>
<meta charset="utf-8">
<title>Todournament</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<style>

@import url(css/bootstrap.css);
@import url(style.css);

</style>

<div class="container">
	<div id="loading">Loading&#8230;</div>
	<div id="error"></div>
	<div id="pile-view"></div>
</div>

<script src="jquery.js"></script>
<script src="jquery.linkify.js"></script>
<script src="js/bootstrap.js"></script>
<script src="js/sets.js"></script>
<script src="underscore.js"></script>
<script src="backbone.js"></script>
<script src="backbone.localStorage.js"></script>
<script src="store.js"></script>
<script src="models.js"></script>
<script src="views.js"></script>


<script>

var pilepile = {
	localStorage: new PileCollection(new LocalStore("piles")),
};

function fetchedPiles(storageName) {
	var d = new $.Deferred;

	var piles = pilepile[storageName];
	if (!piles) {
		d.reject("\"" + storageName + "\" piles not found!");
		return d.promise();
	}

	piles.fetch({reset: true}).then(function () {
		d.resolve(piles);
	}, function () {
		d.reject("Could not fetch \"" + storageName + "\" piles");
	});

	return d.promise();
}

var router = new (Backbone.Router.extend({
	routes: {
		"" : "home",
		"piles/:storageName/:id" : "pile",
	},

	home: function () {
		fetchedPiles("localStorage").then(gotPiles, showError);

		function gotPiles(piles) {
			if (piles.length === 0) {
				var pile = piles.create({ name: "Default" });
				if (pile.has("id")) {
					goToPile(pile);
				} else {
					pile.once("change:id", function () {
						goToPile(pile);
					});
				}
			} else {
				goToPile(piles.at(0));
			}
		}
	},

	pile: function (storageName, id) {
		$("#loading").hide();

		fetchedPiles(storageName).then(gotPiles, showError);

		function gotPiles(piles) {
			var pile = piles.get(id);
			if (pile) {
				new PileView({
					el: $("#pile-view")[0],
					model: pile,
				}).render();
			} else {
				$("#error").text("Pile not found!").show();
			}
		}
	},
}));

function showError(msg) {
	$("#error").text(msg).show();
}

function goToPile(pile) {
	var path = "piles/" + pile.collection.storageName + "/" + pile.id;
	router.navigate(path, {trigger: true});
}

Backbone.history.start();

</script>
